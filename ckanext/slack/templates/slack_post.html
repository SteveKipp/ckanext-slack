{% extends "page.html" %}

{% set pkg_url = h.full_current_url() %}
{% set user = c.userobj %}

{% block styles %}
    {{ super() }}
    {% resource 'slack/slack_window.css' %}
{% endblock %}

{% block primary_content_inner %}
<script>
    window.onload = function() {
        var code = window.location.search.substr(1);
        code = code.substr(0, code.length - 6);
        channels = []
        //readd client id and secret
        $.ajax({
            url: "https://slack.com/api/oauth.access",
            type: "GET",
            contentType: "application/x-www-form-urlencoded; charset=utf-8",
            data: "client_id=&client_secret="+code,
            dataType: "json",
            success: function (req) {
                console.log("Success!")
                console.log(req)
                token1 = req.access_token;
                //window.close()
                $.ajax({
                    url: "https://slack.com/api/channels.list",
                    type: "GET",
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    data: "token="+req.access_token,
                    dataType: "json",
                    success: function (req1) {
                        console.log("Success!")
                        console.log(req1)
                        for(i = 0; i<req1.channels.length; i++){
                            channels.push(req1.channels[i].name)
                        }
                        var sel = document.getElementById('channelSelect');
                        for(var i = 0; i < channels.length; i++) {
                            var opt = document.createElement('option');
                            opt.innerHTML = channels[i];
                            opt.value = channels[i];
                            sel.appendChild(opt);
                        }
                    }

                })
                $.ajax({
                    url: "https://slack.com/api/groups.list",
                    type: "GET",
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    data: "token="+req.access_token,
                    dataType: "json",
                    success: function (req2) {
                        console.log("Success!")
                        console.log(req2)
                        for(i = 0; i<req2.groups.length; i++){
                            channels.push(req2.groups[i].name)
                        }
                        var sel = document.getElementById('channelSelect');
                        for(var i = 0; i < channels.length; i++) {
                            var opt = document.createElement('option');
                            opt.innerHTML = channels[i];
                            opt.value = channels[i];
                            sel.appendChild(opt);
                        }

                    }

                })
            }

        })
    }

    function post1Message(){
            var token = sessionStorage.getItem("slack_user_token")
            var bot = sessionStorage.getItem("slack_bot_id")
            console.log(bot)
            var slack_message = document.getElementById('slackMessage').value
            var channel = document.getElementById('channelSelect').value
            $.ajax({
                url: "https://slack.com/api/chat.postMessage",
                type: "GET",
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                data: "text="+slack_message+"&as_user=true&token="+token1+"&channel="+channel,
                dataType: "json",
                success: function(){
                    console.log("Success!")
                    //window.close()
                }
            })
    }

</script>
    <textarea id="slackMessage"></textarea>
    <script>
        var pkg_title = sessionStorage.getItem("pkg_title");
        var pkg_url = sessionStorage.getItem("pkg_url");
        console.log(pkg_title)
        console.log(pkg_url)
        document.getElementById('slackMessage').value = pkg_title+": "+pkg_url;
    </script>
    </br>
    <select id="channelSelect">
    </select>
    </br>
    <button class="btn btn-primary" id="postButton" onclick="post1Message()">post to slack</button>
{% endblock %}
